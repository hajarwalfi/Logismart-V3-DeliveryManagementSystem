<mat-toolbar color="primary" class="shadow-md">
  <button mat-icon-button (click)="goToDashboard()" matTooltip="Retour au dashboard">
    <mat-icon>arrow_back</mat-icon>
  </button>
  <mat-icon class="mr-2">account_circle</mat-icon>
  <span class="text-xl font-bold">Mon Profil</span>
  <span class="flex-1"></span>
  <span class="text-sm mr-4">{{ currentUser()?.username }}</span>
  <button mat-button (click)="onLogout()" class="hover:bg-white/10">
    <mat-icon>logout</mat-icon>
    Deconnexion
  </button>
</mat-toolbar>

<div class="container mx-auto p-6 max-w-6xl">
  <!-- Profile Section -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Profile Card -->
    <mat-card class="shadow-lg lg:col-span-1">
      <mat-card-header class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-6 rounded-t-lg">
        <div class="w-full text-center">
          <div class="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <mat-icon class="text-5xl">person</mat-icon>
          </div>
          @if (loadingProfile()) {
            <mat-spinner diameter="30" class="mx-auto"></mat-spinner>
          } @else if (profile()) {
            <h2 class="text-2xl font-bold">{{ profile()!.fullName }}</h2>
            <p class="text-white/80">Livreur</p>
          }
        </div>
      </mat-card-header>
      <mat-card-content class="p-6">
        @if (errorProfile()) {
          <div class="text-red-500 text-center py-4">
            <mat-icon>error</mat-icon>
            <p>{{ errorProfile() }}</p>
            <button mat-stroked-button color="primary" (click)="loadProfile()" class="mt-2">
              Reessayer
            </button>
          </div>
        } @else if (!loadingProfile() && profile()) {
          <div class="space-y-4">
            <!-- Phone -->
            <div class="flex items-center">
              <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                <mat-icon class="text-blue-600">phone</mat-icon>
              </div>
              <div>
                <p class="text-sm text-gray-500">Telephone</p>
                <p class="font-medium">{{ profile()!.phone }}</p>
              </div>
            </div>

            <mat-divider></mat-divider>

            <!-- Vehicle -->
            <div class="flex items-center">
              <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
                <mat-icon class="text-green-600">two_wheeler</mat-icon>
              </div>
              <div>
                <p class="text-sm text-gray-500">Vehicule</p>
                <p class="font-medium">{{ profile()!.vehicle || 'Non renseigne' }}</p>
              </div>
            </div>

            <mat-divider></mat-divider>

            <!-- Zone -->
            <div class="flex items-center">
              <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                <mat-icon class="text-purple-600">location_on</mat-icon>
              </div>
              <div>
                <p class="text-sm text-gray-500">Zone assignee</p>
                @if (profile()!.hasAssignedZone) {
                  <p class="font-medium">{{ profile()!.assignedZoneName }}</p>
                } @else {
                  <p class="text-gray-400">Aucune zone assignee</p>
                }
              </div>
            </div>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Statistics Cards -->
    <div class="lg:col-span-2">
      @if (loadingStats()) {
        <div class="flex justify-center items-center h-full">
          <mat-spinner diameter="50"></mat-spinner>
        </div>
      } @else if (errorStats()) {
        <mat-card class="shadow-lg p-6 text-center">
          <mat-icon class="text-red-500 text-4xl">error</mat-icon>
          <p class="text-red-500 mt-2">{{ errorStats() }}</p>
          <button mat-stroked-button color="primary" (click)="loadStats()" class="mt-4">
            Reessayer
          </button>
        </mat-card>
      } @else if (stats()) {
        <!-- Main Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
          <!-- Total Parcels -->
          <mat-card class="shadow-lg hover:shadow-xl transition-shadow">
            <mat-card-content class="p-4 text-center">
              <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <mat-icon class="text-indigo-600">inventory_2</mat-icon>
              </div>
              <p class="text-3xl font-bold text-gray-800">{{ stats()!.totalParcels }}</p>
              <p class="text-sm text-gray-500">Total colis</p>
            </mat-card-content>
          </mat-card>

          <!-- Delivered Total -->
          <mat-card class="shadow-lg hover:shadow-xl transition-shadow">
            <mat-card-content class="p-4 text-center">
              <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <mat-icon class="text-green-600">check_circle</mat-icon>
              </div>
              <p class="text-3xl font-bold text-green-600">{{ stats()!.deliveredParcels }}</p>
              <p class="text-sm text-gray-500">Total livres</p>
            </mat-card-content>
          </mat-card>

          <!-- Success Rate -->
          <mat-card class="shadow-lg hover:shadow-xl transition-shadow">
            <mat-card-content class="p-4 text-center">
              <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <mat-icon class="text-blue-600">trending_up</mat-icon>
              </div>
              <p class="text-3xl font-bold text-blue-600">{{ stats()!.successRate | number:'1.1-1' }}%</p>
              <p class="text-sm text-gray-500">Taux de reussite</p>
            </mat-card-content>
          </mat-card>

          <!-- This Month Delivered -->
          <mat-card class="shadow-lg hover:shadow-xl transition-shadow">
            <mat-card-content class="p-4 text-center">
              <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <mat-icon class="text-orange-600">calendar_today</mat-icon>
              </div>
              <p class="text-3xl font-bold text-orange-600">{{ stats()!.deliveredThisMonth }}</p>
              <p class="text-sm text-gray-500">Livres ce mois</p>
            </mat-card-content>
          </mat-card>

          <!-- Average per Day -->
          <mat-card class="shadow-lg hover:shadow-xl transition-shadow">
            <mat-card-content class="p-4 text-center">
              <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <mat-icon class="text-purple-600">speed</mat-icon>
              </div>
              <p class="text-3xl font-bold text-purple-600">{{ stats()!.avgDeliveriesPerDay | number:'1.1-1' }}</p>
              <p class="text-sm text-gray-500">Moyenne/jour</p>
            </mat-card-content>
          </mat-card>

          <!-- Total Weight -->
          <mat-card class="shadow-lg hover:shadow-xl transition-shadow">
            <mat-card-content class="p-4 text-center">
              <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <mat-icon class="text-gray-600">fitness_center</mat-icon>
              </div>
              <p class="text-3xl font-bold text-gray-600">{{ stats()!.totalWeight | number:'1.1-1' }}</p>
              <p class="text-sm text-gray-500">Kg total</p>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Current Status Summary -->
        <mat-card class="shadow-lg">
          <mat-card-header>
            <mat-card-title class="text-lg">Colis en cours</mat-card-title>
          </mat-card-header>
          <mat-card-content class="p-4">
            <div class="grid grid-cols-4 gap-4 text-center">
              <div>
                <p class="text-2xl font-bold text-yellow-600">{{ stats()!.collectedParcels }}</p>
                <p class="text-xs text-gray-500">Collectes</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-blue-600">{{ stats()!.inStockParcels }}</p>
                <p class="text-xs text-gray-500">En stock</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-orange-600">{{ stats()!.inTransitParcels }}</p>
                <p class="text-xs text-gray-500">En transit</p>
              </div>
              <div>
                <p class="text-2xl font-bold text-red-600">{{ stats()!.activeParcels }}</p>
                <p class="text-xs text-gray-500">Actifs total</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      }
    </div>
  </div>

  <!-- Delivery History Section -->
  <mat-card class="shadow-lg">
    <mat-card-header class="border-b">
      <mat-card-title class="flex items-center">
        <mat-icon class="mr-2">history</mat-icon>
        Historique des livraisons
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      @if (loadingHistory()) {
        <div class="flex justify-center items-center py-12">
          <mat-spinner diameter="50"></mat-spinner>
        </div>
      } @else if (errorHistory()) {
        <div class="text-center py-8">
          <mat-icon class="text-red-500 text-4xl">error</mat-icon>
          <p class="text-red-500 mt-2">{{ errorHistory() }}</p>
          <button mat-stroked-button color="primary" (click)="loadDeliveryHistory()" class="mt-4">
            Reessayer
          </button>
        </div>
      } @else if (deliveryHistory().length === 0) {
        <div class="text-center py-12">
          <mat-icon class="text-gray-400 text-6xl">inbox</mat-icon>
          <h3 class="text-xl font-semibold text-gray-700 mt-4">Aucune livraison effectuee</h3>
          <p class="text-gray-500">Votre historique de livraisons apparaitra ici.</p>
        </div>
      } @else {
        <div class="overflow-x-auto">
          <table mat-table [dataSource]="paginatedHistory()" class="w-full">
            <!-- Date Column -->
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef class="font-bold">Date</th>
              <td mat-cell *matCellDef="let parcel">
                <div class="text-sm">{{ formatDate(parcel.createdAt) }}</div>
              </td>
            </ng-container>

            <!-- Tracking ID Column -->
            <ng-container matColumnDef="trackingId">
              <th mat-header-cell *matHeaderCellDef class="font-bold">ID</th>
              <td mat-cell *matCellDef="let parcel" class="font-mono text-xs">
                {{ parcel.id.substring(0, 8) }}...
              </td>
            </ng-container>

            <!-- Recipient Column -->
            <ng-container matColumnDef="recipient">
              <th mat-header-cell *matHeaderCellDef class="font-bold">Destinataire</th>
              <td mat-cell *matCellDef="let parcel">
                <div class="font-medium">{{ parcel.recipientName }}</div>
                <div class="text-xs text-gray-500">{{ parcel.recipientPhone }}</div>
              </td>
            </ng-container>

            <!-- Destination Column -->
            <ng-container matColumnDef="destination">
              <th mat-header-cell *matHeaderCellDef class="font-bold">Destination</th>
              <td mat-cell *matCellDef="let parcel">
                <div class="flex items-center">
                  <mat-icon class="text-gray-500 mr-1 text-sm">location_on</mat-icon>
                  <span>{{ parcel.destinationCity }}</span>
                </div>
              </td>
            </ng-container>

            <!-- Status Column -->
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef class="font-bold">Statut</th>
              <td mat-cell *matCellDef="let parcel">
                <mat-chip-set>
                  <mat-chip [class]="getStatusColor(parcel.status) + ' text-white'">
                    <mat-icon class="mr-1">{{ getStatusIcon(parcel.status) }}</mat-icon>
                    {{ parcel.statusDisplay }}
                  </mat-chip>
                </mat-chip-set>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: historyColumns;" class="hover:bg-gray-50"></tr>
          </table>
        </div>

        <mat-paginator
          [length]="deliveryHistory().length"
          [pageSize]="historyPageSize()"
          [pageIndex]="historyPage()"
          [pageSizeOptions]="[5, 10, 25, 50]"
          (page)="onHistoryPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      }
    </mat-card-content>
  </mat-card>
</div>
